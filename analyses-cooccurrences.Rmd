---
title: "Analyses co-occurrence grand dauphin et activités humaines"
author: "Olivier Gimenez"
date: "28/09/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, dpi = 300, cache = TRUE)
library(tidyverse)
theme_set(theme_light())
library(lubridate)
library(janitor)
library(sf)
library(patchwork)
```

## Lecture et nettoyage des données

La grille.
```{r}
grid <- st_read("Grid/grid.shp")
grid %>%
  ggplot() +
  geom_sf()
```


Les dauphins. 
```{r}
load("20180914_SAMM_data_LauretValentin.RData")
```

Les données été et hiver.
```{r}
dauphins_summer <- summer
dauphins_winter <- winter
```

Les données transect uniquement.
```{r}
transect_summer <- dauphins_summer$segdata %>%
  as_tibble() %>%
  select(date = date, 
         transect = Transect.Label, 
         eastings = X, 
         northings = Y, 
         counts = n,
         effort = Effort,
         id = Sample.Label) %>%
  add_column(season = "summer")
  
transect_winter <- dauphins_winter$segdata %>%
  as_tibble() %>%
  select(date = date, 
         transect = Transect.Label, 
         eastings = X, 
         northings = Y, 
         counts = n,
         effort = Effort,
         id = Sample.Label) %>%
  add_column(season = "winter")

transect <- bind_rows(transect_summer, transect_winter)
```

Quelques statistiques, avec le nombre de détections par transect.
```{r}
transect %>%
  count(transect, wt = counts, sort = TRUE)
```

Le nombre total de dauphins.
```{r}
transect %>%
  count(transect, wt = counts, sort = TRUE) %>%
  select(n) %>%
  sum()
```


Et l'effort par transect.
```{r}
transect %>%
  group_by(transect) %>%
  summarise(nb_detections = sum(counts),
            effort_total = mean(effort)) %>%
  arrange(desc(nb_detections))
```

L'effort total.
```{r}
transect %>%
  group_by(transect) %>%
  summarise(effort_total = max(effort)) %>%
  select(effort_total) %>%
  sum()
```


Visualisation.
```{r}
grid %>%
  ggplot() +
  geom_sf(lwd = 0.1, color = "black", fill = "white")  + 
  geom_line(data = transect, color = "blue",
            aes(x = eastings, y = northings, group = transect)) +
  coord_sf(xlim = st_bbox(grid)[c(1,3)],
           ylim = st_bbox(grid)[c(2,4)]) +
  geom_point(data = transect %>% filter(counts > 0),
             aes(x = eastings, y = northings, size = counts / effort), 
             color = "red", alpha = 0.6) +
  labs(size = "dolphin encounter rate") +
  facet_wrap(~season, ncol = 1)
```

Les activités.
```{r}
load("20200928_SAMM_data_Pressure.RData")
```

On récupère les activités par saison en les regroupant dans une catégorie unique *pêche*. Il y a le détail : "Bouee de peche", Bateau art dormant (fileyeur, caseyeur)", "Bateau chalutier", "Bateau de peche pro", "Bateau senneur, bolincheur".
```{r}
activ_summer <- transect %>%
  filter(season == "summer") %>%
  mutate(id = as.numeric(id),
         dolphins = if_else(counts>0, 1, 0)) %>%
  select(date, id, eastings, northings, effort, dolphins, transect) %>%
  full_join(summer_fishingactivities$obsdata, by =  c("id" = "Sample.Label")) %>%
  select(date, 
         eastings, 
         northings, 
         dolphins,
         what,
         effort,
         id,
         transect) %>%
  mutate(peche = if_else(!is.na(what), 1, 0)) %>%
  add_column(season = "summer") %>%
  select(date, eastings, northings, dolphins, effort, peche, season, id, transect)

activ_winter <- transect %>%
  filter(season == "winter") %>%
  mutate(id = as.numeric(id),
         dolphins = if_else(counts>0, 1, 0)) %>%
  select(date, id, eastings, northings, effort, dolphins, transect) %>%
  full_join(winter_fishingactivities$obsdata, by =  c("id" = "Sample.Label")) %>%
  select(date, 
         eastings, 
         northings, 
         dolphins,
         what,
         effort,
         id,
         transect) %>%
  mutate(peche = if_else(!is.na(what), 1, 0)) %>%
  add_column(season = "winter") %>%
  select(date, eastings, northings, dolphins, effort, peche, season, id, transect)
  
#summer_fishingactivities$obsdata %>%
#  st_as_sf()
#  st_transform( crs= st_crs(grid))

activ <- bind_rows(activ_summer, activ_winter)
```


Visualisation.
```{r}
grid %>%
  ggplot() +
  geom_sf(lwd = 0.1, color = "black", fill = "white")  + 
  geom_line(data = activ, color = "blue",
            aes(x = eastings, y = northings, group = transect)) +
  coord_sf(xlim = st_bbox(grid)[c(1,3)],
           ylim = st_bbox(grid)[c(2,4)]) +
  geom_point(data = activ %>% filter(peche > 0),
            aes(x = eastings, y = northings), 
             color = "red", alpha = 0.6) +
  facet_wrap(~season, ncol = 1) +
  labs(title = "fishing activities")
```