---
title: "Analyses co-occurrence grand dauphin et activités humaines"
author: "Olivier Gimenez"
date: "28/09/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, dpi = 300, cache = TRUE)
library(tidyverse)
theme_set(theme_light())
library(lubridate)
library(janitor)
library(sf)
library(patchwork)
```

## Lecture et nettoyage des données

La grille.
```{r}
grid <- st_read("Grid/grid.shp")
grid %>%
  ggplot() +
  geom_sf()
```


Les dauphins. 
```{r}
load("20180914_SAMM_data_LauretValentin.RData")
```

Les données été et hiver.
```{r}
dauphins_summer <- summer
dauphins_winter <- winter
```

Les données transect uniquement.
```{r}
transect_summer <- dauphins_summer$segdata %>%
  as_tibble() %>%
  select(date = date, 
         transect = Transect.Label, 
         eastings = X, 
         northings = Y, 
         counts = n,
         effort = Effort,
         id = Sample.Label) %>%
  add_column(season = "summer")
  
transect_winter <- dauphins_winter$segdata %>%
  as_tibble() %>%
  select(date = date, 
         transect = Transect.Label, 
         eastings = X, 
         northings = Y, 
         counts = n,
         effort = Effort,
         id = Sample.Label) %>%
  add_column(season = "winter")

transect <- bind_rows(transect_summer, transect_winter)
```

Quelques statistiques, avec le nombre de détections par transect.
```{r}
transect %>%
  count(transect, wt = counts, sort = TRUE)
```

Le nombre total de dauphins.
```{r}
transect %>%
  count(transect, wt = counts, sort = TRUE) %>%
  select(n) %>%
  sum()
```


Et l'effort par transect.
```{r}
transect %>%
  group_by(transect) %>%
  summarise(nb_detections = sum(counts),
            effort_total = mean(effort)) %>%
  arrange(desc(nb_detections))
```

L'effort total.
```{r}
transect %>%
  group_by(transect) %>%
  summarise(effort_total = max(effort)) %>%
  select(effort_total) %>%
  sum()
```


Visualisation.
```{r}
grid %>%
  ggplot() +
  geom_sf(lwd = 0.1, color = "black", fill = "white")  + 
  geom_line(data = transect, color = "blue",
            aes(x = eastings, y = northings, group = transect)) +
  coord_sf(xlim = st_bbox(grid)[c(1,3)],
           ylim = st_bbox(grid)[c(2,4)]) +
  geom_point(data = transect %>% filter(counts > 0),
             aes(x = eastings, y = northings, size = counts / effort), 
             color = "red", alpha = 0.6) +
  labs(size = "dolphin encounter rate") +
  facet_wrap(~season, ncol = 1)
```

Les activités.
```{r}
load("20200928_SAMM_data_Pressure.RData")
```

On récupère les activités par saison en les regroupant dans une catégorie unique *pêche*. Il y a le détail : "Bouee de peche", Bateau art dormant (fileyeur, caseyeur)", "Bateau chalutier", "Bateau de peche pro", "Bateau senneur, bolincheur".
```{r}
activ_summer <- transect %>%
  filter(season == "summer") %>%
  mutate(id = as.numeric(id),
         dolphins = if_else(counts>0, 1, 0)) %>%
  select(date, id, eastings, northings, effort, dolphins, transect) %>%
  full_join(summer_fishingactivities$obsdata, by =  c("id" = "Sample.Label")) %>%
  select(date, 
         eastings, 
         northings, 
         dolphins,
         what,
         effort,
         id,
         transect) %>%
  mutate(peche = if_else(!is.na(what), 1, 0)) %>%
  add_column(season = "summer") %>%
  select(date, eastings, northings, dolphins, effort, peche, season, id, transect)

activ_winter <- transect %>%
  filter(season == "winter") %>%
  mutate(id = as.numeric(id),
         dolphins = if_else(counts>0, 1, 0)) %>%
  select(date, id, eastings, northings, effort, dolphins, transect) %>%
  full_join(winter_fishingactivities$obsdata, by =  c("id" = "Sample.Label")) %>%
  select(date, 
         eastings, 
         northings, 
         dolphins,
         what,
         effort,
         id,
         transect) %>%
  mutate(peche = if_else(!is.na(what), 1, 0)) %>%
  add_column(season = "winter") %>%
  select(date, eastings, northings, dolphins, effort, peche, season, id, transect)
  
activ <- bind_rows(activ_summer, activ_winter)
```

Quelques statistiques, avec le nombre d'activités par transect.
```{r}
activ %>%
  group_by(transect, season) %>%
  summarise(n_peche = sum(peche)) %>%
  filter(n_peche>0) %>%
  arrange(desc(n_peche))
```

Visualisation.
```{r}
grid %>%
  ggplot() +
  geom_sf(lwd = 0.1, color = "black", fill = "white")  + 
  geom_line(data = activ, color = "blue",
            aes(x = eastings, y = northings, group = transect)) +
  coord_sf(xlim = st_bbox(grid)[c(1,3)],
           ylim = st_bbox(grid)[c(2,4)]) +
  geom_point(data = activ %>% filter(peche > 0),
            aes(x = eastings, y = northings), 
             color = "red", alpha = 0.6) +
  facet_wrap(~season, ncol = 1) +
  labs(title = "fishing activities")
```

## Construction des chroniques de détection/non-détections des sites

Get transects and grid in same coordinates system.
```{r}
transect_line <- activ %>%
  mutate(month = month(date)) %>%
  select(eastings, northings, date, dolphins, peche, season, id, transect, month) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("eastings", "northings"), 
           crs = "+proj=longlat +init=EPSG:3035")

st_crs(grid) <- "+proj=longlat +init=EPSG:3035"
```

Intersect the grid and the transects.
```{r}
int <- transect_line %>%
  st_intersection(grid)
```



Select those cells which intersect with the transects.
```{r}
all_df <- grid %>%
  filter(objectid %in% int$objectid) %>%
  st_join(int %>% mutate(peche = as_factor(peche),
                         dolphins = as_factor(dolphins))) %>%
  mutate(month = as_factor(month),
         month = fct_relevel(month, c("11", "12", "1", "2", "5", "6", "7", "8")))
```

Fishing activities per month.
```{r}
all_df %>%
  ggplot() +
  geom_sf(lwd = 0.1, color = "black", aes(fill = peche))  + 
  coord_sf(xlim = st_bbox(grid)[c(1,3)],
           ylim = st_bbox(grid)[c(2,4)]) +
  scale_fill_manual(values = c('gray90','steelblue4'),
                    name = "fishing activites",
                    labels = c("absent", "present")) +
  facet_wrap(~month, ncol = 4)
```

Dolphin presence per month.
```{r}
all_df %>%
  ggplot() +
  geom_sf(lwd = 0.1, color = "black", aes(fill = dolphins))  + 
  coord_sf(xlim = st_bbox(grid)[c(1,3)],
           ylim = st_bbox(grid)[c(2,4)]) +
  scale_fill_manual(values = c('gray90','steelblue4'),
                    name = "dolphin observations",
                    labels = c("non-detected", "detected")) +
  facet_wrap(~month, ncol = 4)
```

We have everything to build the cells detection-non/detection histories. Basically, the grey cells are gonna be 0's, the blue cells 1's and those cells that are not sampled in a month NA's. 
```{r}
all_df %>%
  add_count(transect, wt = as.numeric(dolphins)) %>%
  complete(transect) %>%
  mutate(tursiops = case_when(
  n == 1 ~ "NA",
  n == 2 ~ "non-detected",
  n > 2 ~ "detected"),
  tursiops = as_factor(tursiops)) %>%
  select(transect, dolphins, n, tursiops)
  


#  head() %>%
#  mutate(occ1 = if_else(month == "11" | ))
#  pivot_wider(c(date, season), 
#              values_from = dolphins, 
#              names_from = month)
  
  
  
  
  
    # 
    # mutate(dolphins = fct_recode(dolphins, "ND" = "0", "D" = "1"),
    #      month = fct_recode(month, 
    #                         "dec" = "12", 
    #                         "nov" = "11",  
    #                         "jan" = "1", 
    #                         "feb" = "2", 
    #                         "may" = "5", 
    #                         "jun" = "6", 
    #                         "jul" = "7", 
    #                         "aug"=  "8")) %>%
```

